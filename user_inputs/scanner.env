# Scanner configuration (KEY=VALUE)
# Shared, documented template.
# Put machine-specific values and personal overrides in: user_inputs/scanner.local.env
# (scanner.local.env is loaded AFTER this file.)
# EIDAT_TRENDING_COMBINED_ONLY=1 forces trending extraction to use combined.txt only (skips acceptance)
EIDAT_TRENDING_COMBINED_ONLY=1
QUIET=1
REPO_ROOT=C:\EIDAT PROD TEST\PROGRAM A\EIDAT
OCR_MODE=fallback
OCR_DPI=450
EASYOCR_LANGS=en
OCR_ROW_EPS=33
DEBUG_MODE=1
FUZZY_PRESET=strict
OCR_TESS_PSM=6
SMART_SEC_YPAD=40
TESS_LANG=eng+equ
TESS_OEM=1
TESS_PSM=6
TESS_RETRY_MAX_TOKENS=48
TESS_RETRY_MIN_CONF=0.82
XY_FUZZ=0.00

# Per-page extraction timeout (seconds) for the *entire page pipeline* (OCR + tables + charts).
# Set to 0 to disable (recommended if you only want to skip table detection on "graph" pages).
EIDAT_PAGE_TIMEOUT_SEC=0

# Disable chart detection/extraction globally (prevents chart bboxes from hiding text in combined.txt).
EIDAT_ENABLE_CHART_EXTRACTION=0

# =============================================================================
# TABLE EXTRACTION (OCR + DETECTION)
# =============================================================================

# === OCR DPI Overrides (migrated from ocr_force.env) ===
# These control the default extraction pipeline DPI knobs.
EIDAT_TABLE_OCR_DPI=450
EIDAT_PAGE_RENDER_DPI=450
EIDAT_TABLE_DETECTION_DPI=900

# === Admin "Process" Overrides (optional) ===
# These are used by the Admin Dashboard when processing nodes.
# Leave as 0/blank to use normal defaults.
#EIDAT_PROCESS_FORCE=0
#EIDAT_PROCESS_LIMIT=0
#EIDAT_PROCESS_DPI=0

# =============================================================================
# KV / TERM-VALUE READING (NON-TABLE LINES)
# =============================================================================

# --- KV: Fuzzy Header Stick (OFF by default) ---
# When you set a workbook row's `Header` to a long-form column name, allow fuzzy matching
# to abbreviated OCR headers (e.g. "propellant valve resistance" ~= "prop. valve res.").
# This affects ONLY header/column matching; it does NOT change term matching.
EIDAT_FUZZY_HEADER_STICK=0
# Minimum match ratio (0..1). Higher is stricter (fewer false matches).
EIDAT_FUZZY_HEADER_MIN_RATIO=0.72

# --- Trending: Fuzzy Term Stick (ON by default) ---
# When populating EIDP Trending workbooks, allow fuzzy matching between the workbook `Term`/`TermLabel`
# and table row labels found in `combined.txt` / extracted acceptance data.
# This helps when terms vary slightly across documents (spacing, abbreviations, punctuation).
EIDAT_FUZZY_TERM_STICK=1
# Minimum match ratio (0..1). Higher is stricter (fewer false matches).
EIDAT_FUZZY_TERM_MIN_RATIO=0.78

# --- KV: Gap Split Heuristic (ON by default) ---
# Converts single-line "Term     Value" (clear horizontal gap) into "Term | Value".
# This helps extract kv_pairs when the line isn't boxed as a table.
# Disable by setting EIDAT_KV_GAP_SPLIT=0
EIDAT_KV_GAP_SPLIT=1

# Merged bundle (eidp_term_scanner.core.py) whitespace-gap threshold.
# Minimum consecutive spaces/tabs required to treat the line as a term/value split.
EIDAT_KV_GAP_MIN_SPACES=8

# Debug exporter (extraction pipeline) token-gap thresholds.
# If the horizontal gap between adjacent tokens exceeds BOTH:
#   - EIDAT_KV_GAP_MIN_PX (absolute pixels)
#   - (line_height * EIDAT_KV_GAP_H_MULT)
# then the line is rendered as "Term | Value".
EIDAT_KV_GAP_MIN_PX=0
EIDAT_KV_GAP_H_MULT=2.5

# =============================================================================
# TABLE EXTRACTION (POST-PROCESSING)
# =============================================================================

# --- Tables: Cell text normalization (ON by default) ---
# Strips common leading border artifacts caused by table line detection / border remnants in OCR.
# Examples: `|"Pressure` -> `Pressure`, `["Flow` -> `Flow`, `â”‚ 10.0` -> `10.0`
# Disable by setting to 0.
EIDAT_TABLE_CELL_PREFIX_CLEAN=1

# --- Tables: Clustering Gap Control (bordered tables) ---
# Lower = less merging across white gaps.
# Effective gap threshold (in detection-DPI pixels):
#   gap = max(page_w, page_h) * EIDAT_TABLE_CLUSTER_GAP_RATIO
#   if EIDAT_TABLE_CLUSTER_GAP_PX > 0: gap = min(gap, EIDAT_TABLE_CLUSTER_GAP_PX)
EIDAT_TABLE_CLUSTER_GAP_RATIO=0.005
EIDAT_TABLE_CLUSTER_GAP_PX=25

# Guardrail: if bordered-table detection produces too many cells (common on chart grids),
# skip clustering to avoid extreme slowdowns.
EIDAT_TABLE_DETECT_MAX_CLUSTER_CELLS=200

# Master toggle: set to 0 to disable table-detection guardrails (caps + timeouts) for debugging.
# WARNING: disabling may reintroduce hangs on chart/grid pages.
EIDAT_TABLE_DETECT_GUARDRAILS=0

# Per-page timeout for bordered table detection only (seconds).
# When exceeded, the page continues processing (OCR still runs), but bordered tables are skipped.
# Recommended: 300 (5 minutes).
EIDAT_TABLE_DETECT_TIMEOUT_SEC=300

# Guardrail: cap corner-based bordered-cell reconstruction (can hang on chart/grid intersections).
# Set to 0 to disable the corner-based method entirely.
#EIDAT_TABLE_DETECT_MAX_CORNERS=300

# =============================================================================
# TABLE OUTPUT (ASCII / combined.txt)
# =============================================================================
# Recommended defaults (most runs):
#   - EIDAT_TABLE_SPLIT_MODE=replica
#   - EIDAT_COMBINED_TABLE_SPLIT_MODE=vline

# --- Tables: Split stacked tables by vline mismatch (tunable) ---
# The extractor will split a detected table whenever per-row internal vertical boundaries
# differ by more than this tolerance (in detection-DPI pixels). Lower = more splitting.
EIDAT_TABLE_SPLIT_VLINE_MISALIGN_PX=20

# --- Tables: Post-processing mode (you said: almost always `replica`) ---
# - replica (recommended): do NOT split; render ASCII tables using snapped bbox gridlines (more faithful layout)
# - vline              : split stacked tables using the vline-mismatch heuristic
# - none               : do NOT split; keep default ASCII renderer
EIDAT_TABLE_SPLIT_MODE=replica

# --- combined.txt: Split mode (you said: use `vline` with `replica`) ---
# ASCII-only; no additional OCR.
# - vline   (recommended): apply vline-mismatch splitting when writing combined.txt
# - inherit            : follow EIDAT_TABLE_SPLIT_MODE
# - none               : do not split when writing combined.txt
EIDAT_COMBINED_TABLE_SPLIT_MODE=vline
# Optional overrides for combined.txt splitting (defaults fall back to the table-split envs):
#EIDAT_COMBINED_TABLE_SPLIT_VLINE_MISALIGN_PX=20
#EIDAT_COMBINED_TABLE_SPLIT_VLINE_MIN_RUN=2
#EIDAT_COMBINED_TABLE_SPLIT_SINGLE_CELL_SEPARATOR=1
#EIDAT_COMBINED_TABLE_SPLIT_SINGLE_CELL_SEPARATOR_MAX_H_RATIO=0.45

# Optional: require a mismatch to persist for N rows before splitting.
# Helps avoid over-splitting from a single bad/merged row. (1 = current/most sensitive)
#EIDAT_TABLE_SPLIT_VLINE_MIN_RUN=2
#
# Optional: control the special "single-cell separator row" split.
# By default, a 1-cell row between multi-cell regions can be treated as a separator and split out.
# If you have legit header/colspan rows, consider either disabling or enabling the height filter.
#EIDAT_TABLE_SPLIT_SINGLE_CELL_SEPARATOR=1
# Only split a 1-cell separator row if its row height <= (median multi-cell row height * ratio).
# 0 disables the height filter (current behavior).
#EIDAT_TABLE_SPLIT_SINGLE_CELL_SEPARATOR_MAX_H_RATIO=0.45

# --- ASCII table rendering (replica mode) ---
# This controls how tables are *written as ASCII text* into artifacts like `combined.txt` and
# debug outputs (e.g. `variant_fused_majority.txt`). It does NOT change OCR itself -- it only
# affects how much text can fit per column when rendering wide tables.
#
# Common symptom this fixes:
# - Wide/landscape tables where many columns get clipped/truncated in the `.txt` output.
#
# EIDAT_TABLE_ASCII_MAX_WIDTH:
# - Unset OR <= 0 (recommended): enable AUTO width for wide tables (prevents column collapse/clipping).
# - > 0 (fixed): force a hard maximum ASCII width in characters (can re-introduce clipping).
#
# Notes:
# - AUTO width only *increases* width when needed; small tables stay compact.
# - Larger widths create longer lines in the `.txt` file (less readable in some editors).
#EIDAT_TABLE_ASCII_MAX_WIDTH=0
#
# AUTO width behavior knobs (used only when MAX_WIDTH is unset/auto):
# - AUTO_MIN_COL_CHARS: try to guarantee at least this many characters per column on very wide tables
#   by increasing the overall ASCII width. Increase this if you still see clipping.
# - AUTO_CAP: absolute ceiling for auto width to prevent gigantic lines on extreme tables.
#
# Rough mental model (auto mode):
#   target_width ~= (ncols * AUTO_MIN_COL_CHARS) + (ncols + 1 borders)
#   max_width   = min(AUTO_CAP, max(default_width, target_width))
#EIDAT_TABLE_ASCII_AUTO_MIN_COL_CHARS=16
#EIDAT_TABLE_ASCII_AUTO_CAP=2000
#
# Snapping (replica-grid) knobs:
# Replica mode reconstructs a grid by snapping cell bbox edges together. These tolerances are in
# DETECTION-DPI pixels (see `EIDAT_TABLE_DETECTION_DPI`, typically 900).
#
# EIDAT_TABLE_ASCII_SNAP_TOL_PX:
# - 0 (recommended): auto tolerance based on table size + border thickness inference (most robust).
# - > 0: fixed tolerance for both X and Y snapping (useful for debugging, but less adaptive).
#
# EIDAT_TABLE_ASCII_SNAP_TOL_RATIO (auto mode only; ignored when SNAP_TOL_PX > 0):
# - Controls how aggressive snapping is as tables get larger.
# - Lower = stricter snapping (more unique gridlines -> more columns/rows, risk of "sliver" columns).
# - Higher = looser snapping (more merging, risk of collapsing true separators).
#
# Auto tolerance (simplified mental model):
#   tol_x ~= clamp(table_w * ratio, 2px floor, SNAP_MAX_PX cap)
#   tol_y ~= clamp(table_h * ratio, 6px floor, SNAP_MAX_PX cap)
# The renderer may further increase tolerance when it detects repeated small edge gaps
# (border thickness / row-to-row bbox inset), to collapse outer-frame sliver columns.
#
# If you get:
# - "sliver" columns / too many columns: increase SNAP_MAX_PX (or set SNAP_TOL_PX higher).
# - merged columns / lost separators: decrease SNAP_MAX_PX (or set SNAP_TOL_PX lower).
#EIDAT_TABLE_ASCII_SNAP_TOL_PX=0
# EIDAT_TABLE_ASCII_SNAP_TOL_RATIO=0.006
# SNAP_MAX_PX caps the auto tolerance (and any border-thickness boosts) so snapping can't get too loose.
# Typical range: 10..25. Higher can help collapse noisy/sliver edges; lower preserves separators.
EIDAT_TABLE_ASCII_SNAP_MAX_PX=15

# === Faint/Thin Line Help (Bordered Tables) ===
# If table borders are too faint for bordered-cell detection, try either:
#  1) Enable borderless table detection (token-grid; does not rely on drawn lines), OR
#  2) Increase sensitivity of the bordered line/cell detector.
#
# Option 1 (recommended fallback when borders are unreliable):
#EIDAT_TABLE_ENABLE_BORDERLESS=1
#
# Option 2 (bordered detector sensitivity):
# - Raise BIN_HIGH_THRESH to include lighter gray strokes (default 200).
# - Increase dilation to connect broken strokes.
# - Enable CLAHE to boost local contrast on washed-out scans.
#EIDAT_TABLE_DETECT_BIN_HIGH_THRESH=230
#EIDAT_TABLE_DETECT_ADAPT_BLOCK=25
#EIDAT_TABLE_DETECT_ADAPT_C=8
# Bridge broken/faint strokes before line extraction:
#EIDAT_TABLE_DETECT_PRE_CLOSE=1
#EIDAT_TABLE_DETECT_H_CLOSE_W=3
#EIDAT_TABLE_DETECT_H_CLOSE_H=1
#EIDAT_TABLE_DETECT_V_CLOSE_W=1
#EIDAT_TABLE_DETECT_V_CLOSE_H=3
#EIDAT_TABLE_DETECT_H_DILATE_W=7
#EIDAT_TABLE_DETECT_H_DILATE_H=3
#EIDAT_TABLE_DETECT_V_DILATE_W=3
#EIDAT_TABLE_DETECT_V_DILATE_H=7
#EIDAT_TABLE_DETECT_GRID_DILATE=3
#EIDAT_TABLE_DETECT_CONTOUR_FILL_MIN=0.65
#EIDAT_TABLE_DETECT_CLAHE=1
#EIDAT_TABLE_DETECT_CLAHE_CLIP=2.0
#EIDAT_TABLE_DETECT_CLAHE_TILE=16
# Optional denoise (can hurt very thin lines if set too high):
#EIDAT_TABLE_DETECT_BLUR_K=0
